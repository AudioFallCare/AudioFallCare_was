name: Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44

      - name: Review PR
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(' ');
            const additions = ${{ github.event.pull_request.additions }};
            const deletions = ${{ github.event.pull_request.deletions }};
            const changedFilesCount = changedFiles.length;

            let review = [];
            review.push('## üìã PR ÏûêÎèô Î¶¨Î∑∞\n');

            // Summary
            review.push('### üìä Î≥ÄÍ≤Ω ÏÇ¨Ìï≠ ÏöîÏïΩ');
            review.push(`- üìÅ Î≥ÄÍ≤ΩÎêú ÌååÏùº: **${changedFilesCount}Í∞ú**`);
            review.push(`- ‚ûï Ï∂îÍ∞ÄÎêú Ï§Ñ: **${additions}Ï§Ñ**`);
            review.push(`- ‚ûñ ÏÇ≠Ï†úÎêú Ï§Ñ: **${deletions}Ï§Ñ**`);
            review.push('');

            // File categorization for Spring Boot
            const fileTypes = {
              controllers: [],
              services: [],
              repositories: [],
              entities: [],
              dtos: [],
              configs: [],
              tests: [],
              others: []
            };

            for (const file of changedFiles) {
              if (!file) continue;
              if (file.includes('Controller')) fileTypes.controllers.push(file);
              else if (file.includes('Service')) fileTypes.services.push(file);
              else if (file.includes('Repository')) fileTypes.repositories.push(file);
              else if (file.includes('Entity') || file.includes('entity')) fileTypes.entities.push(file);
              else if (file.includes('Dto') || file.includes('dto')) fileTypes.dtos.push(file);
              else if (file.includes('Config') || file.includes('config')) fileTypes.configs.push(file);
              else if (file.includes('Test') || file.includes('test')) fileTypes.tests.push(file);
              else fileTypes.others.push(file);
            }

            review.push('### üìÇ Î≥ÄÍ≤ΩÎêú ÌååÏùº Î∂ÑÎ•ò');
            if (fileTypes.controllers.length) review.push(`- üéÆ Controller: ${fileTypes.controllers.length}Í∞ú`);
            if (fileTypes.services.length) review.push(`- ‚öôÔ∏è Service: ${fileTypes.services.length}Í∞ú`);
            if (fileTypes.repositories.length) review.push(`- üóÑÔ∏è Repository: ${fileTypes.repositories.length}Í∞ú`);
            if (fileTypes.entities.length) review.push(`- üì¶ Entity: ${fileTypes.entities.length}Í∞ú`);
            if (fileTypes.dtos.length) review.push(`- üì® DTO: ${fileTypes.dtos.length}Í∞ú`);
            if (fileTypes.configs.length) review.push(`- üîß Config: ${fileTypes.configs.length}Í∞ú`);
            if (fileTypes.tests.length) review.push(`- üß™ Test: ${fileTypes.tests.length}Í∞ú`);
            if (fileTypes.others.length) review.push(`- üì¶ Í∏∞ÌÉÄ: ${fileTypes.others.length}Í∞ú`);
            review.push('');

            // Checklist
            review.push('### ‚úÖ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏');
            review.push('- [ ] ÏΩîÎìúÍ∞Ä ÌîÑÎ°úÏ†ùÌä∏ Ïª®Î≤§ÏÖòÏùÑ Îî∞Î•¥ÎäîÏßÄ ÌôïÏù∏');
            review.push('- [ ] API ÏóîÎìúÌè¨Ïù∏Ìä∏ Î¨∏ÏÑúÌôî Ïó¨Î∂Ä ÌôïÏù∏');
            review.push('- [ ] ÏòàÏô∏ Ï≤òÎ¶¨Í∞Ä Ï†ÅÏ†àÌïúÏßÄ ÌôïÏù∏');
            review.push('- [ ] ÌÖåÏä§Ìä∏ ÏΩîÎìú ÏûëÏÑ± Ïó¨Î∂Ä ÌôïÏù∏');
            review.push('- [ ] SQL Ïù∏Ï†ùÏÖò Îì± Î≥¥Ïïà Ï∑®ÏïΩÏ†ê ÌôïÏù∏');
            review.push('');

            // Warnings
            let warnings = [];
            if (additions > 500) warnings.push('‚ö†Ô∏è Î≥ÄÍ≤ΩÎüâÏù¥ 500Ï§ÑÏùÑ Ï¥àÍ≥ºÌï©ÎãàÎã§. PRÏùÑ Îçî ÏûëÍ≤å ÎÇòÎàÑÎäî Í≤ÉÏùÑ Í≥†Î†§Ìï¥Ï£ºÏÑ∏Ïöî.');
            if (changedFilesCount > 20) warnings.push('‚ö†Ô∏è 20Í∞ú Ïù¥ÏÉÅÏùò ÌååÏùºÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§. PRÏùÑ Îçî ÏûëÍ≤å ÎÇòÎàÑÎäî Í≤ÉÏùÑ Í≥†Î†§Ìï¥Ï£ºÏÑ∏Ïöî.');
            if (fileTypes.tests.length === 0 && (fileTypes.services.length > 0 || fileTypes.controllers.length > 0)) {
              warnings.push('üí° Service/Controller Î≥ÄÍ≤ΩÏù¥ ÏûàÏßÄÎßå ÌÖåÏä§Ìä∏ ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§. ÌÖåÏä§Ìä∏ Ï∂îÍ∞ÄÎ•º Í≥†Î†§Ìï¥Ï£ºÏÑ∏Ïöî.');
            }

            if (warnings.length > 0) {
              review.push('### ‚ö†Ô∏è Ï£ºÏùòÏÇ¨Ìï≠');
              warnings.forEach(w => review.push(w));
            }

            // Post comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c => c.user.login === 'github-actions[bot]' && c.body.includes('PR ÏûêÎèô Î¶¨Î∑∞'));

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: review.join('\n')
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: review.join('\n')
              });
            }
